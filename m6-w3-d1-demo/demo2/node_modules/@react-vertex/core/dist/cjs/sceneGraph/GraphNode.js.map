{"version":3,"sources":["../../../src/sceneGraph/GraphNode.ts"],"names":["isGraphNode","Symbol","GraphNode","parent","children","matrix","worldMatrix","needsMatrixUpdate","userManagedMatrix","position","rotation","scale","root","mat4","create","child","updateWorldMatrix","push","index","findIndex","d","splice","SceneNode","copy","multiply","identity","translate","x","y","z","rotateX","rotateY","rotateZ","nextprops","prevProps","forEach","c","renderOnUpdate","requestRender"],"mappings":"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","sourcesContent":["import { mat4, vec3 } from 'gl-matrix'\nimport { SceneNode } from './SceneNode'\n\nimport { MatrixProps } from '../types'\n\nexport const isGraphNode = Symbol('isGraphNode')\n\nexport default class GraphNode {\n  parent?: GraphNode\n  children: GraphNode[]\n  matrix: mat4\n  worldMatrix: mat4\n  needsMatrixUpdate: boolean\n  userManagedMatrix: boolean\n\n  position?: vec3\n  rotation?: vec3\n  scale?: vec3\n\n  root?: SceneNode\n\n  constructor() {\n    this.children = []\n    this.matrix = mat4.create()\n    this.worldMatrix = mat4.create()\n    this.needsMatrixUpdate = false\n    this.userManagedMatrix = false\n  }\n\n  [isGraphNode] = true\n\n  add(child: GraphNode) {\n    child.parent = this\n    child.updateWorldMatrix()\n    this.children.push(child)\n  }\n\n  remove(child: GraphNode) {\n    const index = this.children.findIndex(d => d === child)\n\n    if (index >= 0) {\n      delete this.children[index].parent\n      this.children.splice(index, 1)\n    }\n  }\n\n  updateWorldMatrix() {\n    if (this instanceof SceneNode) {\n      mat4.copy(this.worldMatrix, this.matrix)\n    } else if (this.parent) {\n      mat4.multiply(this.worldMatrix, this.parent.worldMatrix, this.matrix)\n    }\n  }\n\n  updateMatrix() {\n    if (this.userManagedMatrix) {\n      return\n    }\n\n    mat4.identity(this.matrix)\n\n    if (this.position) {\n      mat4.translate(this.matrix, this.matrix, this.position)\n    }\n\n    if (this.rotation) {\n      const [x, y, z] = this.rotation\n      x && mat4.rotateX(this.matrix, this.matrix, x)\n      y && mat4.rotateY(this.matrix, this.matrix, y)\n      z && mat4.rotateZ(this.matrix, this.matrix, z)\n    }\n\n    if (this.scale) {\n      mat4.scale(this.matrix, this.matrix, this.scale)\n    }\n  }\n\n  applyMatrixProps(nextprops: MatrixProps, prevProps: MatrixProps) {\n    if (nextprops.matrix) {\n      this.matrix = nextprops.matrix\n      this.userManagedMatrix = true\n      this.updateWorldMatrix()\n\n      this.children.forEach(c => (c.needsMatrixUpdate = true))\n    } else if (\n      nextprops.position !== prevProps.position ||\n      nextprops.rotation !== prevProps.rotation ||\n      nextprops.scale !== prevProps.scale\n    ) {\n      this.position = nextprops.position\n      this.rotation = nextprops.rotation\n      this.scale = nextprops.scale\n\n      this.needsMatrixUpdate = true\n    }\n\n    if (this.root && this.root.renderOnUpdate) {\n      this.root.requestRender()\n    }\n  }\n}\n"],"file":"GraphNode.js"}